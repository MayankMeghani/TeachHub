@model EnrollmentViewModel

@{
    ViewData["Title"] = "Enroll in Course";
}
<div class="container my-5">
    <h1 class="display-4 text-center mb-4">Enroll in @ViewBag.Course.Title</h1>

    <h4 class="mt-4">Course Details</h4>
    <hr />
    <div class="mb-4">
        <p class="mb-1" style="font-size: 1.25rem;"><strong>Title:</strong> <span class="text-muted">@ViewBag.Course.Title</span></p>
        <p class="mb-1" style="font-size: 1.25rem;"><strong>Description:</strong> <span class="text-muted">@ViewBag.Course.Description</span></p>
        <p class="mb-1" style="font-size: 1.5rem;"><strong>Price:</strong> <span class="text-success display-6">₹@ViewBag.Course.Price</span></p>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <form asp-action="Enroll" method="post" id="enrollment-form" class="shadow-sm p-4 border border-light rounded bg-light">
                <input type="hidden" asp-for="CourseId" value="@ViewBag.Course.CourseId" />
                <input type="hidden" asp-for="LearnerId" value="@ViewData["LearnerId"]" />

                <!-- Payment fields -->
                <h4 class="mt-4 mb-3">Payment Details</h4>
                <p class="mb-3">You need to pay: <strong class="text-success display-6">₹@ViewBag.Course.Price</strong></p>

                <div class="card border-primary mb-3">
                    <div class="card-header text-white bg-primary">
                        <h5 class="mb-0">Enter Your Payment Details</h5>
                    </div>
                    <div class="card-body">

                        <div  class="d-flex justify-content-center mb-3">
                            <div id="spinner" class="spinner-border text-primary" role="status"></div>
                        </div>

                        <div id="card-element" class="p-3" style="border: 1px solid #ced4da; border-radius: 5px; display: none;">
                        </div>
                        <small class="form-text text-muted mt-2">Your payment information will secured.</small>
                    </div>
                </div>

                <input type="hidden" id="stripeToken" name="stripeToken" />

                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" id="pay-button" class="btn btn-success btn-lg" disabled>Pay and Enroll Now</button>
                    <a asp-action="Details" asp-route-id="@ViewBag.Course.CourseId" class="btn btn-danger btn-lg">Cancel</a>
                </div>

                <div id="payment-response" class="mt-3 text-danger">
                    @if (!string.IsNullOrEmpty(ViewBag.PaymentError))
                    {
                        <p>@ViewBag.PaymentError</p>
                    }
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const stripe = Stripe('@ViewBag.StripePublishableKey');
        const elements = stripe.elements();
        const cardElement = elements.create('card');

        const cardElementContainer = document.getElementById('card-element');
        const spinner = document.getElementById('spinner');
        const payButton = document.getElementById('pay-button');

        // Initially hide the card element and show the spinner
        cardElementContainer.style.display = 'none';
        spinner.style.display = 'block';
        payButton.disabled = true;

        // Mount the card element and handle readiness
        cardElement.mount(cardElementContainer);
        cardElement.on('ready', function () {
            // Hide spinner and show card element when it's ready
            cardElementContainer.style.display = 'block';
            spinner.style.display = 'none';
            payButton.disabled = false;
        });

        // Handle errors from card element
        cardElement.on('change', function (event) {
            if (event.error) {
                // Display the error message if any
                document.getElementById('payment-response').innerText = event.error.message;
            }
        });

        const paymentForm = document.getElementById('enrollment-form');
        paymentForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent the default form submission

            payButton.disabled = true;
            spinner.style.display = 'block'; // Show spinner when submitting

            const { token, error } = await stripe.createToken(cardElement);
            if (error) {
                document.getElementById('payment-response').innerText = error.message;
                spinner.style.display = 'none'; // Hide spinner on error
                payButton.disabled = false; // Re-enable the button
            } else {
                document.getElementById('stripeToken').value = token.id;

                // Optionally hide the spinner before submitting the form
                spinner.style.display = 'none';
                paymentForm.submit(); // Submit the form with the token
            }
        });
    </script>
}


