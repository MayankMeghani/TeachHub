@model EnrollmentViewModel

@{
    ViewData["Title"] = "Enroll in Course";
}
<div class="container my-5">
    <h1 class="display-4 text-center mb-4">Enroll in @ViewBag.Course.Title</h1>

    <h4 class="mt-4">Course Details</h4>
    <hr />
    <div class="mb-4">
        <p class="mb-1" style="font-size: 1.25rem;"><strong>Title:</strong> <span class="text-muted">@ViewBag.Course.Title</span></p>
        <p class="mb-1" style="font-size: 1.25rem;"><strong>Description:</strong> <span class="text-muted">@ViewBag.Course.Description</span></p>
        <p class="mb-1" style="font-size: 1.5rem;"><strong>Price:</strong> <span class="text-success display-6">₹@ViewBag.Course.Price</span></p>
    </div>

    <div class="row">
        <div class="col-md-8 mx-auto">
            <form asp-action="Enroll" method="post" id="enrollment-form" class="shadow-sm p-4 border border-light rounded bg-light">
                <input type="hidden" asp-for="CourseId" value="@ViewBag.Course.CourseId" />
                <input type="hidden" asp-for="LearnerId" value="@ViewData["LearnerId"]" />

                <!-- Payment fields -->
                <h4 class="mt-4 mb-3">Payment Details</h4>
                <p class="mb-3">You need to pay: <strong class="text-success display-6">₹@ViewBag.Course.Price</strong></p>

                <div class="card border-primary mb-3">
                    <div class="card-header text-white bg-primary">
                        <h5 class="mb-0">Enter Your Payment Details</h5>
                    </div>
                    <div class="card-body">

                        <div  class="d-flex justify-content-center mb-3">
                            <div id="spinner" class="spinner-border text-primary" role="status"></div>
                        </div>

                        <div id="card-element" class="p-3" style="border: 1px solid #ced4da; border-radius: 5px; display: none;">
                        </div>
                        <small class="form-text text-muted mt-2">Your payment information will be secured.</small>
                    </div>
                </div>

                <input type="hidden" id="stripeToken" name="stripeToken" />

                <div class="d-flex justify-content-between mt-4">
                    <button type="submit" id="pay-button" class="btn btn-success btn-lg" disabled>Pay and Enroll Now</button>
                    <a asp-action="Details" asp-route-id="@ViewBag.Course.CourseId" id="cancel-button" class="btn btn-danger btn-lg">Cancel</a>
                </div>

                <div id="payment-response" class="mt-3 text-danger">
                    @if (!string.IsNullOrEmpty(ViewBag.PaymentError))
                    {
                        <p>@ViewBag.PaymentError</p>
                    }
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const stripe = Stripe('@ViewBag.StripePublishableKey');
            const elements = stripe.elements();
            const cardElement = elements.create('card');

            const cardElementContainer = document.getElementById('card-element');
            const spinner = document.getElementById('spinner');
            const payButton = document.getElementById('pay-button');
            const cancelButton = document.getElementById('cancel-button');
            const paymentResponse = document.getElementById('payment-response');

            function setFormState(isProcessing) {
                payButton.disabled = isProcessing;
                cancelButton.style.pointerEvents = isProcessing ? 'none' : 'auto';
                cancelButton.style.opacity = isProcessing ? '0.5' : '1';
                spinner.style.display = isProcessing ? 'block' : 'none';
                cardElementContainer.style.display = isProcessing ? 'none' : 'block';
            }

            // Initially show spinner and disable buttons
            setFormState(true);

            cardElement.mount(cardElementContainer);
            cardElement.on('ready', function () {
                setFormState(false);
            });

            cardElement.on('change', function (event) {
                if (event.error) {
                    paymentResponse.innerText = event.error.message;
                } else {
                    paymentResponse.innerText = '';
                }
            });

            const paymentForm = document.getElementById('enrollment-form');
            paymentForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                setFormState(true);

                try {
                    const { token, error } = await stripe.createToken(cardElement);
                    if (error) {
                        throw error;
                    }
                    document.getElementById('stripeToken').value = token.id;
                    paymentForm.submit();
                } catch (error) {
                    paymentResponse.innerText = error.message;
                    setFormState(false);
                }
            });
        });
    </script>

}


